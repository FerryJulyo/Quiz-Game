<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Quiz Game Interaktif dengan Leaderboard</title>
<style>
  /* Reset and base */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg,#667eea,#764ba2);
    color: #fff;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px 10px;
  }
  #app {
    background: rgba(255,255,255,0.1);
    max-width: 440px;
    width: 100%;
    border-radius: 12px;
    box-shadow: 0 12px 25px rgba(0,0,0,0.3);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 660px;
  }
  header {
    text-align: center;
    padding: 20px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.3);
  }
  header h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.8rem;
    letter-spacing: 1px;
  }
  main {
    flex: 1;
    padding: 20px 25px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .section {
    display: none;
  }
  .section.active {
    display: block;
  }

  label {
    display: block;
    margin: 12px 0 8px;
    font-weight: 600;
    font-size: 1rem;
  }
  select, input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
    outline: none;
    font-family: inherit;
    cursor: pointer;
    background: rgba(255,255,255,0.25);
    color: #fff;
  }
  input[type="text"] {
    cursor: text;
  }
  button {
    margin-top: 20px;
    background: #6b5b95;
    border: none;
    color: white;
    padding: 15px 0;
    font-size: 1.1rem;
    font-weight: 700;
    border-radius: 50px;
    letter-spacing: 1px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
  }
  button:hover:not([disabled]) {
    background-color: #836fa9;
  }
  button:disabled {
    background-color: rgba(107,91,149,0.5);
    cursor: default;
    box-shadow: none;
  }

  .leaderboard-section {
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 12px;
    margin-bottom: 20px;
    padding: 15px 15px 10px 15px;
    max-height: 220px;
    overflow-y: auto;
    background-color: rgba(255,255,255,0.05);
  }
  .lb-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
  }
  .lb-filters select {
    flex: 1;
  }
  table.leaderboard-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }
  table.leaderboard-table th, table.leaderboard-table td {
    border: 1px solid rgba(255,255,255,0.3);
    padding: 6px 8px;
    text-align: left;
  }
  table.leaderboard-table th {
    background: rgba(255,255,255,0.15);
    font-weight: 700;
  }
  table.leaderboard-table tr:nth-child(even) {
    background: rgba(255,255,255,0.1);
  }

  .question-container {
    margin-top: 10px;
    font-size: 1.2rem;
    min-height: 100px;
    line-height: 1.4;
    font-weight: 600;
  }
  .options {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  .option {
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    padding: 12px 18px;
    font-size: 1.1rem;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  .option:hover {
    background: rgba(255,255,255,0.35);
  }
  .option.selected {
    background: #ffb600;
    color: #222;
    font-weight: 700;
  }
  .option.correct {
    background: #4caf50;
    color: #fff;
    font-weight: 700;
    cursor: default;
  }
  .option.incorrect {
    background: #f44336;
    color: #fff;
    font-weight: 700;
    cursor: default;
  }
  .stats {
    margin-top: 20px;
    color: #eee;
    font-weight: 600;
    font-size: 1rem;
  }
  .footer {
    padding: 15px 25px;
    border-top: 1px solid rgba(255,255,255,0.25);
    text-align: center;
    font-size: 0.9rem;
    color: #ddd;
  }
</style>
</head>
<body>
<div id="app" role="main" aria-live="polite">
  <header>
    <h1>Quiz Game Interaktif</h1>
  </header>
  <main>

    <!-- Leaderboard -->
    <section id="leaderboard-section" class="leaderboard-section" aria-label="Leaderboard Top 10">
      <div class="lb-filters" aria-label="Filters leaderboard">
        <select id="lb-topic-filter" aria-label="Filter topik leaderboard">
          <option value="all" selected>Semua Topik</option>
          <option value="general">Pengetahuan Umum</option>
          <option value="science">SAINS</option>
          <option value="civics">Kewarganegaraan Indonesia</option>
        </select>
        <select id="lb-difficulty-filter" aria-label="Filter tingkat kesulitan leaderboard">
          <option value="all" selected>Semua Kesulitan</option>
          <option value="easy">Mudah</option>
          <option value="medium">Sedang</option>
          <option value="hard">Sulit</option>
        </select>
      </div>
      <table class="leaderboard-table" aria-live="polite">
        <thead>
          <tr>
            <th>No</th>
            <th>Nama</th>
            <th>Skor</th>
            <th>Topik</th>
            <th>Kesulitan</th>
            <th>Tanggal</th>
          </tr>
        </thead>
        <tbody id="leaderboard-tbody">
          <tr><td colspan="6" style="text-align:center; color:#ccc;">Tidak ada data leaderboard</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Pilih topik dan kesulitan -->
    <section id="setup" class="section active" aria-label="Setup quiz">
      <label for="player-name">Masukkan Nama (untuk leaderboard):</label>
      <input type="text" id="player-name" maxlength="20" placeholder="Nama Anda" aria-required="true" />
      <label for="topic-select">Pilih Topik</label>
      <select id="topic-select" aria-required="true">
        <option value="" disabled selected>-- Pilih Topik --</option>
        <option value="general">Pengetahuan Umum</option>
        <option value="science">SAINS</option>
        <option value="civics">Kewarganegaraan Indonesia</option>
      </select>
      <label for="difficulty-select">Pilih Tingkat Kesulitan</label>
      <select id="difficulty-select" aria-required="true">
        <option value="" disabled selected>-- Pilih Kesulitan --</option>
        <option value="easy">Mudah</option>
        <option value="medium">Sedang</option>
        <option value="hard">Sulit</option>
      </select>
      <button id="start-btn" disabled>Mulai Quiz</button>
    </section>
    <!-- Quiz Question -->
    <section id="quiz" class="section" aria-label="Quiz questions">
      <div class="question-container" id="question-text" tabindex="0"></div>
      <div class="options" id="options-list" role="list"></div>
      <button id="next-btn" disabled>Soal Berikutnya</button>
      <div class="stats" id="question-count" aria-live="polite"></div>
    </section>
    <!-- Result -->
    <section id="result" class="section" aria-label="Hasil Quiz">
      <h2>Hasil Quiz</h2>
      <p id="score-text"></p>
      <button id="restart-btn">Main Lagi</button>
    </section>
  </main>
  <footer class="footer">
    &copy; 2024 Quiz Game Interaktif
  </footer>
</div>

<script>
(() => {
  // Sama dengan sebelumnya: questionBank, topicNames, difficultyNames
  // (Untuk ringkas, saya tidak mengulangi seluruh bank soal di sini, asumsikan sama)

  const questionBank = {
    general: { easy: [...], medium: [...], hard: [...] },
    science: { easy: [...], medium: [...], hard: [...] },
    civics: { easy: [...], medium: [...], hard: [...] }
  };
  const topicNames = { general: "Pengetahuan Umum", science: "SAINS", civics: "Kewarganegaraan Indonesia" };
  const difficultyNames = { easy: "Mudah", medium: "Sedang", hard: "Sulit" };

  // App state
  let currentTopic = null;
  let currentDifficulty = null;
  let questions = [];
  let currentIndex = 0;
  let score = 0;
  let userAnswers = [];
  let shuffledOptions = [];

  // Leaderboard data key
  const LB_STORAGE_KEY = 'quizLeaderboard';
  let leaderboardData = [];

  // DOM elements
  const setupSection = document.getElementById('setup');
  const playerNameInput = document.getElementById('player-name');
  const topicSelect = document.getElementById('topic-select');
  const difficultySelect = document.getElementById('difficulty-select');
  const startBtn = document.getElementById('start-btn');

  const quizSection = document.getElementById('quiz');
  const questionText = document.getElementById('question-text');
  const optionsList = document.getElementById('options-list');
  const nextBtn = document.getElementById('next-btn');
  const questionCount = document.getElementById('question-count');

  const resultSection = document.getElementById('result');
  const scoreText = document.getElementById('score-text');
  const restartBtn = document.getElementById('restart-btn');

  // Leaderboard DOM
  const lbTopicFilter = document.getElementById('lb-topic-filter');
  const lbDifficultyFilter = document.getElementById('lb-difficulty-filter');
  const leaderboardTbody = document.getElementById('leaderboard-tbody');

  // Enable start button if name, topic, difficulty selected
  function checkStartValidity() {
    startBtn.disabled = !(playerNameInput.value.trim() && topicSelect.value && difficultySelect.value);
  }
  playerNameInput.addEventListener('input', checkStartValidity);
  topicSelect.addEventListener('change', checkStartValidity);
  difficultySelect.addEventListener('change', checkStartValidity);

  // Fisher-Yates shuffle
  function shuffleArray(arr) {
    for (let i = arr.length -1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i +1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  // Load leaderboard from localStorage
  function loadLeaderboard() {
    try {
      const data = localStorage.getItem(LB_STORAGE_KEY);
      leaderboardData = data ? JSON.parse(data) : [];
    } catch(e) {
      leaderboardData = [];
    }
  }

  // Save leaderboard to localStorage
  function saveLeaderboard() {
    localStorage.setItem(LB_STORAGE_KEY, JSON.stringify(leaderboardData));
  }

  // Render leaderboard table with optional filters
  function renderLeaderboard() {
    const topicFilterVal = lbTopicFilter.value;
    const difficultyFilterVal = lbDifficultyFilter.value;

    let filteredData = leaderboardData;

    if(topicFilterVal !== 'all') {
      filteredData = filteredData.filter(item => item.topic === topicFilterVal);
    }
    if(difficultyFilterVal !== 'all') {
      filteredData = filteredData.filter(item => item.difficulty === difficultyFilterVal);
    }

    // Sort descending by score, then date descending
    filteredData.sort((a,b) => b.score - a.score || new Date(b.date) - new Date(a.date));

    // Take top 10
    const top10 = filteredData.slice(0, 10);

    leaderboardTbody.innerHTML = '';
    if(top10.length === 0){
      leaderboardTbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#ccc;">Tidak ada data leaderboard</td></tr>`;
      return;
    }

    top10.forEach((item, i) => {
      const tr = document.createElement('tr');

      const dateFormatted = new Date(item.date).toLocaleDateString('id-ID', {year:'numeric', month:'short', day:'numeric'});

      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHtml(item.name)}</td>
        <td>${item.score}</td>
        <td>${topicNames[item.topic] || item.topic}</td>
        <td>${difficultyNames[item.difficulty] || item.difficulty}</td>
        <td>${dateFormatted}</td>
      `;
      leaderboardTbody.appendChild(tr);
    });
  }

  // Simple HTML escape to prevent injection
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Start quiz with chosen settings
  function startQuiz() {
    currentTopic = topicSelect.value;
    currentDifficulty = difficultySelect.value;
    const pool = questionBank[currentTopic][currentDifficulty];

    // Clone and shuffle questions pool
    questions = [...pool];
    shuffleArray(questions);

    // Pick 10 or less questions if less available
    questions = questions.slice(0, 10);

    currentIndex = 0;
    score = 0;
    userAnswers = [];
    shuffledOptions = [];

    setupSection.classList.remove('active');
    resultSection.classList.remove('active');
    quizSection.classList.add('active');

    renderQuestion();
  }

  // Render current question and options - with answer shuffling
  function renderQuestion() {
    const q = questions[currentIndex];
    questionText.textContent = `Soal ${currentIndex + 1}: ${q.question}`;

    // Lock next btn until user select
    nextBtn.disabled = true;

    // Prepare options with original index
    let optionsWithIndex = q.options.map((opt, idx) => ({opt, idx}));
    shuffleArray(optionsWithIndex);

    // Store shuffled options for checking answer on selection
    shuffledOptions = optionsWithIndex;

    optionsList.innerHTML = '';
    optionsWithIndex.forEach(({opt, idx}, i) => {
      const optionDiv = document.createElement('div');
      optionDiv.classList.add('option');
      optionDiv.setAttribute('role', 'listitem');
      optionDiv.setAttribute('tabindex', 0);
      optionDiv.textContent = opt;
      optionDiv.dataset.originalIndex = idx;
      optionDiv.dataset.shuffledIndex = i;
      optionDiv.addEventListener('click', onSelectOption);
      optionDiv.addEventListener('keydown', function(e){
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          this.click();
        }
      });
      optionsList.appendChild(optionDiv);
    });

    updateQuestionCount();
  }

  // Update question count display
  function updateQuestionCount(){
    questionCount.textContent = `Topik: ${topicNames[currentTopic]} | Tingkat Kesulitan: ${difficultyNames[currentDifficulty]} | Soal ke ${currentIndex + 1} dari ${questions.length}`;
  }

  // Handle option selection
  function onSelectOption(e){
    if (nextBtn.disabled === false) return;

    const selectedDiv = e.currentTarget;
    const selectedOriginalIdx = parseInt(selectedDiv.dataset.originalIndex, 10);
    const correctOriginalIndex = questions[currentIndex].answer;

    [...optionsList.children].forEach(optionEl => {
      optionEl.classList.remove('selected','correct','incorrect');
      optionEl.removeAttribute('aria-pressed');
    });

    selectedDiv.classList.add('selected');
    selectedDiv.setAttribute('aria-pressed', 'true');

    if(selectedOriginalIdx === correctOriginalIndex) {
      selectedDiv.classList.add('correct');
      score++;
    } else {
      selectedDiv.classList.add('incorrect');
      for(const optEl of optionsList.children){
        if(parseInt(optEl.dataset.originalIndex,10) === correctOriginalIndex){
          optEl.classList.add('correct');
          break;
        }
      }
    }

    userAnswers[currentIndex] = selectedOriginalIdx;
    nextBtn.disabled = false;
    nextBtn.focus();
  }

  // Move to next question or show result
  function onNextQuestion(){
    currentIndex++;
    if(currentIndex < questions.length){
      renderQuestion();
    } else {
      showResult();
    }
  }

  // Show result page
  function showResult(){
    quizSection.classList.remove('active');
    resultSection.classList.add('active');

    scoreText.textContent = `Skor Anda: ${score} dari ${questions.length} (${Math.round(score / questions.length * 100)}%)`;

    // Simpan ke leaderboard
    const playerName = playerNameInput.value.trim() || "Anonim";
    const entry = {
      name: playerName,
      score: score,
      topic: currentTopic,
      difficulty: currentDifficulty,
      date: new Date().toISOString()
    };
    leaderboardData.push(entry);
    saveLeaderboard();
    renderLeaderboard();

    restartBtn.focus();
  }

  // Restart quiz (back to setup)
  function restartQuiz(){
    currentTopic = null;
    currentDifficulty = null;
    questions = [];
    currentIndex = 0;
    score = 0;
    userAnswers = [];
    shuffledOptions = [];

    playerNameInput.value = '';
    topicSelect.value = '';
    difficultySelect.value = '';
    startBtn.disabled = true;

    resultSection.classList.remove('active');
    setupSection.classList.add('active');
    playerNameInput.focus();
  }

  // Event listeners
  startBtn.addEventListener('click', startQuiz);
  nextBtn.addEventListener('click', onNextQuestion);
  restartBtn.addEventListener('click', restartQuiz);

  lbTopicFilter.addEventListener('change', renderLeaderboard);
  lbDifficultyFilter.addEventListener('change', renderLeaderboard);

  // Accessibility focus handling
  playerNameInput.addEventListener('input', () => {
    if(!startBtn.disabled) startBtn.focus();
  });

  // Initialize leaderboard on load
  loadLeaderboard();
  renderLeaderboard();

  // Check start btn if user reload page with input
  checkStartValidity();

})();
</script>
</body>
</html>
